#!/usr/bin/env ruby
require 'up/cli'

if RUBY_ENGINE == 'opal'
  require 'up/node/cluster_cli'
  Up::CLI.call
else
  Up::CLI.setup_esbuild
  Up::CLI.setup_ws_node
  lib_dir = File.expand_path("#{__dir__}/../lib")
  gems = Up::CLI.get_gems_for_cmd
  `bundle exec opal --no-source-map -c -E -I. -I#{lib_dir} -g rack #{gems} #{__FILE__} -o opal_up.js`
  `npm x esbuild -- --target=node22 --minify opal_up.js --outfile=opal_up.min.js`
  File.delete('opal_up.js')
  exec("node opal_up.min.js -- #{ARGV.join(' ')}")
end
